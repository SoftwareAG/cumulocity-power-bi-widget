!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@c8y/ngx-components"),require("powerbi-client"),require("@c8y/client"),require("@angular/forms"),require("@angular/router"),require("ngx-bootstrap/collapse"),require("rxjs")):"function"==typeof define&&define.amd?define("powerbi-runtime-widget",["exports","@angular/core","@c8y/ngx-components","powerbi-client","@c8y/client","@angular/forms","@angular/router","ngx-bootstrap/collapse","rxjs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["powerbi-runtime-widget"]={},e.ng.core,e["@c8y/ngx-components"],e.pbiClient,e.client,e.ng.forms,e.ng.router,e.collapse,e.rxjs)}(this,(function(e,t,r,n,o,i,s,a,c){"use strict";function p(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var l=p(n);
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function h(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))}function d(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}Object.create;Object.create;var u=function(){function e(e){this.fetchClient=e,this.path=null,this.path=""}return e.prototype.Get=function(e,t,r){return void 0===r&&(r={accept:"application/json"}),h(this,void 0,void 0,(function(){var n;return d(this,(function(o){return"GET",n={method:"GET",headers:r,params:t},[2,this.fetchClient.fetch(this.getEndPoint(e),n)]}))}))},e.prototype.Head=function(e,t,r){return void 0===r&&(r={accept:"application/json"}),h(this,void 0,void 0,(function(){var n;return d(this,(function(o){return"HEAD",n={method:"HEAD",headers:r,params:t},[2,this.fetchClient.fetch(this.getEndPoint(e),n)]}))}))},e.prototype.Post=function(e,t,r,n){return void 0===n&&(n={accept:"application/json"}),h(this,void 0,void 0,(function(){return d(this,(function(o){return[2,this.fetchClient.fetch(this.getEndPoint(e),{method:"POST",body:JSON.stringify(t),headers:n,params:r})]}))}))},e.prototype.Delete=function(e,t,r){return void 0===r&&(r={accept:"application/json"}),h(this,void 0,void 0,(function(){var n;return d(this,(function(o){return"DELETE",n={method:"DELETE",headers:r,params:t},[2,this.fetchClient.fetch(this.getEndPoint(e),n)]}))}))},e.prototype.getEndPoint=function(e){return this.path+e},e}();u.decorators=[{type:t.Injectable}],u.ctorParameters=function(){return[{type:o.FetchClient}]};var f=function(){function e(t){this.http=t,this.path="",this.configRequested=!1,this.cachedInfo=JSON.parse(JSON.stringify(e.cachedInfoDefault))}return e.prototype.setConfigRequestState=function(){this.configRequested=!0},e.prototype.getConfigRequestState=function(){return this.configRequested},e.prototype.getConfig=function(){return h(this,void 0,void 0,(function(){var e;return d(this,(function(t){switch(t.label){case 0:return e=this.path+"/config",[4,this.http.Get(e)];case 1:return[2,t.sent()]}}))}))},e.prototype.save=function(e){return h(this,void 0,void 0,(function(){var t;return d(this,(function(r){switch(r.label){case 0:return t=this.path+"/config",[4,this.http.Post(t,e)];case 1:return[2,r.sent()]}}))}))},e.prototype.delete=function(){return h(this,void 0,void 0,(function(){var e,t;return d(this,(function(r){switch(r.label){case 0:return e=this.path+"/config",t={timeout:5e3},[4,this.http.Delete(e,t)];case 1:return[2,r.sent()]}}))}))},e.prototype.listWorkspaces=function(){return h(this,void 0,void 0,(function(){var e;return d(this,(function(t){switch(t.label){case 0:return e=this.path+"/groups",[4,this.http.Get(e)];case 1:return[2,t.sent()]}}))}))},e.prototype.listReports=function(e){return h(this,void 0,void 0,(function(){var t,r;return d(this,(function(n){switch(n.label){case 0:return t=this.path+"/reports",r={groupId:e},[4,this.http.Get(t,r)];case 1:return[2,n.sent()]}}))}))},e.prototype.embedReport=function(e,t){return h(this,void 0,void 0,(function(){var r,n;return d(this,(function(o){switch(o.label){case 0:return r=this.path+"/embedReport",n={groupId:e,reportId:t},[4,this.http.Get(r,n)];case 1:return[2,o.sent()]}}))}))},e.prototype.flushCache=function(){this.cachedInfo=JSON.parse(JSON.stringify(e.cachedInfoDefault))},e}();f.cachedInfoDefault={reports:[],activeToken:"",settings:null},f.decorators=[{type:t.Injectable}],f.ctorParameters=function(){return[{type:u}]};var g=function(){function e(e,t,r){this.powerbiService=e,this.alertService=t,this.http=r,this.powerbi=new l.service.Service(l.factories.hpmFactory,l.factories.wpmpFactory,l.factories.routerFactory),this.workspaces=[],this.settingsNotDefined=!1,this.isLoading=!1,this.embedUrl="https://app.powerbi.com/reportEmbed"}return e.prototype.ngOnChanges=function(e){return h(this,void 0,void 0,(function(){return d(this,(function(t){switch(t.label){case 0:return e.embeddingInfo&&e.embeddingInfo.currentValue?[4,this.ngOnInit()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))},e.prototype.ngOnInit=function(){return h(this,void 0,void 0,(function(){return d(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),this.http.path=this.config.datahubEndPoint,this.powerbiService.path=this.config.powerBIEndPoint,[4,this.loadReport(this.config)];case 1:return e.sent(),[3,3];case 2:return e.sent(),this.alertService.danger("Failed to load report."),[3,3];case 3:try{this.embedReport(this.embeddingInfo.reportId,this.embeddingInfo.embeddingToken,this.config.isFilterPaneEnabled,this.config.isNavPaneEnabled)}catch(e){this.alertService.danger("Failed to fetch embedding token.")}return[2]}}))}))},e.prototype.embedReport=function(e,t,r,n){var o=this,i={type:"report",id:e,embedUrl:this.embedUrl,tokenType:l.models.TokenType.Embed,accessToken:t,settings:{filterPaneEnabled:r,navContentPaneEnabled:n,background:l.models.BackgroundType.Transparent}},s=this.reportContainer.nativeElement;this.powerbi.reset(s);var a=this.powerbi.embed(s,i);a.off("error"),a.on("error",(function(e){o.alertService.danger("Failed to embed report.")}))},e.prototype.loadReport=function(e){return h(this,void 0,void 0,(function(){var e;return d(this,(function(t){switch(t.label){case 0:return this.workspaceID=this.config.workspaceSelected.id,this.reportID=this.config.reportSelected.id,this.reportName=this.config.reportSelected.name,[4,this.getToken(this.reportID,this.workspaceID,this.reportName)];case 1:return(e=t.sent())&&(this.embeddingInfo={reportId:this.reportID,embeddingToken:e}),[2]}}))}))},e.prototype.getToken=function(e,t,r){return h(this,void 0,void 0,(function(){var n,o;return d(this,(function(i){switch(i.label){case 0:return i.trys.push([0,5,,6]),[4,this.powerbiService.embedReport(this.workspaceID,this.reportID)];case 1:return 200!==(n=i.sent()).status?[3,3]:[4,n.json()];case 2:if("SUCCEEDED"===(o=i.sent()).status)return this.embeddedReport=o.data,this.reportToDisplay={id:e,workspaceId:t,token:this.embeddedReport.token,name:r},[2,this.embeddedReport.token];throw this.alertService.danger("Error in payload"),Error();case 3:throw this.alertService.danger("Error in tokenRequest"),Error();case 4:return[3,6];case 5:return i.sent(),this.alertService.danger("An error occurred while fetching the embedding token for the report."),[3,6];case 6:return[2]}}))}))},e}();g.decorators=[{type:t.Component,args:[{selector:"gp-powerbi-widget",template:'\r\n<div class="card content-fullpage" style="height: 100%;">\r\n    <div class="d-flex d-col inner-scroll fit-h">\r\n    <div class="card-header separator sticky-top">\r\n        <h4>\r\n\t\t\t\t\x3c!-- We are doing some decoding of the report name due to the way we store the report name in the application \r\n\t\t\t\t\tDecoding may not be needed --\x3e\r\n            \x3c!-- {{\r\n          AppUtils.decodeUriComponent(reportName) !== reportName ?\r\n            AppUtils.decodeUriComponent(reportName) :\r\n            reportName\r\n            }}  --\x3e\r\n\r\n            {{reportName}}\r\n            Power Bi Report\r\n        </h4>\r\n    </div>\r\n    <div class="flex-grow p-16" style="height: 100%;">\r\n      <div class="powerbi-report" style="height: inherit;" id="reportContainer" #reportContainer>\r\n        <c8y-loading></c8y-loading>\r\n      </div>\r\n    </div>\r\n    </div>\r\n</div>\r\n'}]}],g.ctorParameters=function(){return[{type:f},{type:r.AlertService},{type:u}]},g.propDecorators={reportContainer:[{type:t.ViewChild,args:["reportContainer",{static:!0}]}],config:[{type:t.Input}]};var v=function(){function e(e,t,r,n){this.powerbiService=e,this.fb=t,this.alertService=r,this.http=n,this.config={powerBIEndPoint:"",datahubEndPoint:""},this.isFilterPaneEnabled=!1,this.isNavPaneEnabled=!1,this.workspaceIndex=0,this.isLoading=!1,this.testUrl="hello",this.onClose=new c.Subject,this.modalResult={workspaceId:null,report:null},this.error="",this.form=this.fb.group({workspace:this.fb.control(null,i.Validators.required),report:this.fb.control(null,i.Validators.required)})}return e.prototype.ngOnInit=function(){return h(this,void 0,void 0,(function(){return d(this,(function(e){return this.config.isNavPaneEnabled||(this.config.isNavPaneEnabled=!1),""===this.config.powerBIEndPoint?this.config.powerBIEndPoint="/powerbi":t.isDevMode()&&console.log(this.config.powerBIEndPoint),""===this.config.datahubEndPoint?this.config.datahubEndPoint="/service/datahub":t.isDevMode()&&console.log(this.config.datahubEndPoint),"/service/datahub"!==this.config.datahubEndPoint||"/powerbi"!==this.config.powerBIEndPoint?this.setUrlAndGetWorkspace():(this.http.path=this.config.datahubEndPoint,this.powerbiService.path=this.config.powerBIEndPoint,this.getReport()),[2]}))}))},e.prototype.setUrlAndGetWorkspace=function(){t.isDevMode()&&console.log("setUrlAndGetWorkspace Config URL",this.config.powerBIEndPoint,this.config,this.config.datahubEndPoint),this.http.path=this.config.datahubEndPoint,this.powerbiService.path=this.config.powerBIEndPoint,this.getReport()},e.prototype.getReport=function(){return h(this,void 0,void 0,(function(){var e,t,r,n;return d(this,(function(o){switch(o.label){case 0:return[4,this.powerbiService.getConfig()];case 1:return 200!==(e=o.sent()).status?[3,3]:[4,e.json()];case 2:return o.sent(),[3,4];case 3:this.alertService.danger("Cannot find the Path"),o.label=4;case 4:return[4,this.powerbiService.listWorkspaces()];case 5:return 200!==(t=o.sent()).status?[3,10]:[4,t.json()];case 6:return"SUCCEEDED"!==(r=o.sent()).status?[3,10]:(this.workspaces=r.data,0!==this.workspaces.length?[3,7]:(this.alertService.danger("Cannot select report because no workspaces are available."),[3,9]));case 7:return n=this.extractWorkspaceIndex(),[4,this.fetchReportsForFirstWorkspaceAndShow(n)];case 8:o.sent(),this.initForm(),o.label=9;case 9:return[3,10];case 10:return[2]}}))}))},e.prototype.extractWorkspaceIndex=function(){var e=this;return this.workspaces.findIndex((function(t){return t.id===e.config.workspaceSelected.id}))},e.prototype.extractReportIndex=function(){var e=this;return this.reports[0].findIndex((function(r,n){if(r.id===e.config.reportSelected.id)return 1;t.isDevMode()&&console.log("no matching in reports")}))},e.prototype.initForm=function(){var e=this,t=this.extractWorkspaceIndex(),r=this.extractReportIndex();this.form=t?this.fb.group({workspace:this.fb.control(this.workspaces[t],i.Validators.required),report:this.fb.control(this.reports[0].length>0?this.reports[0][r]:null,i.Validators.required)}):this.fb.group({workspace:this.fb.control(this.workspaces[0],i.Validators.required),report:this.fb.control(this.reports[0].length>0?this.reports[0][0]:null,i.Validators.required)}),this.visibleReports=this.reports[0],this.workspaces.slice(1,this.workspaces.length).forEach((function(){e.reports.push(null)})),this.config.reportSelected=this.form.controls.report.value,this.config.workspaceSelected=this.form.controls.workspace.value,this.form.controls.workspace.valueChanges.subscribe((function(t){return h(e,void 0,void 0,(function(){var e,r,n;return d(this,(function(o){switch(o.label){case 0:if(!((e=this.workspaces.findIndex((function(e){return e===t})))>=0))return[3,18];if(null!==this.reports[e])return[3,9];o.label=1;case 1:return o.trys.push([1,6,7,8]),this.error="",this.isLoading=!0,[4,this.powerbiService.listReports(this.workspaces[e].id)];case 2:return 200!==(r=o.sent()).status?[3,4]:[4,r.json()];case 3:if("SUCCEEDED"!==(n=o.sent()).status)throw Error();return this.reports[e]=n.data,this.reports[e].length>0?(this.form.controls.workspace.setValue(this.workspaces[e]),this.form.controls.report.setValue(this.reports[e][0])):this.form.controls.report.setValue(null),this.form.updateValueAndValidity(),[3,5];case 4:throw this.form.controls.report.setValue(null),Error();case 5:return[3,8];case 6:return o.sent(),this.error="Fetching reports for workspace failed.",[3,8];case 7:return this.isLoading=!1,[7];case 8:return[3,17];case 9:return o.trys.push([9,14,15,16]),this.error="",this.isLoading=!0,[4,this.powerbiService.listReports(this.workspaces[e].id)];case 10:return 200!==(r=o.sent()).status?[3,12]:[4,r.json()];case 11:if("SUCCEEDED"!==(n=o.sent()).status)throw Error();return this.reports[e]=n.data,this.reports[e].length>0?this.form.controls.report.setValue(this.reports[e][0]):this.form.controls.report.setValue(null),this.form.updateValueAndValidity(),[3,13];case 12:throw this.form.controls.report.setValue(null),Error();case 13:return[3,16];case 14:return o.sent(),this.error="Fetching reports for workspace failed.",[3,16];case 15:return this.isLoading=!1,[7];case 16:this.error="",o.label=17;case 17:this.visibleReports=this.reports[e],this.workspaceIndex=e,this.config.workspaceSelected=this.form.controls.workspace.value,o.label=18;case 18:return[2]}}))}))})),this.form.controls.report.valueChanges.subscribe((function(t){return h(e,void 0,void 0,(function(){return d(this,(function(e){return this.reports.findIndex((function(e){return e===t})),this.config.reportSelected=t,[2]}))}))}))},e.prototype.fetchReportsForFirstWorkspaceAndShow=function(e){return h(this,void 0,void 0,(function(){var t,n;return d(this,(function(o){switch(o.label){case 0:return o.trys.push([0,8,,9]),t=void 0,e?[4,this.powerbiService.listReports(this.workspaces[e].id)]:[3,2];case 1:return t=o.sent(),[3,4];case 2:return[4,this.powerbiService.listReports(this.workspaces[0].id)];case 3:t=o.sent(),o.label=4;case 4:return 200!==t.status?[3,6]:[4,t.json()];case 5:if("SUCCEEDED"!==(n=o.sent()).status)throw Error();return this.reports=[],this.reports.push(n.data),{workspaces:this.workspaces,reports:this.reports},[3,7];case 6:throw Error();case 7:return[3,9];case 8:return o.sent(),r.gettext("An error occurred while fetching reports of workspace {{workspaceName}}. Try again."),this.alertService.danger("workspaceName: ",this.workspaces[0].name),[3,9];case 9:return[2]}}))}))},e}();v.decorators=[{type:t.Component,args:[{selector:"gp-powerbi-config",template:'<div class="viewport-modal configSection">\r\n  <div class=\'row\'>\r\n    <div class="col-xs-3 col-md-3">\r\n      <label for="Datahub URL">\r\n        {{\'DataHub URL\'}}\r\n      </label>\r\n      <input type="text" [(ngModel)]="config.datahubEndPoint">\r\n    </div>\r\n    <div class="col-xs-1 col-md-1 col-lg-1"></div>\r\n    <div class="col-xs-3 col-md-3">\r\n      <label for="Power BI URL">\r\n        {{\'Power BI URL\'}}\r\n      </label>\r\n      <input type="text" [(ngModel)]="config.powerBIEndPoint">\r\n    </div>\r\n    <div class="col-xs-1 col-md-1 col-lg-1"></div>\r\n    <div class="col-xs-3 col-md-3">\r\n\r\n      <button (click)="setUrlAndGetWorkspace()" class="btn btn-primary" style="margin-top: 24px;\r\n      line-height: 14px;">\r\n        {{\'Fetch Data\'}}</button>\r\n    </div>\r\n  </div>\r\n  <div class="row">\r\n    <div class="col-xs-3 col-md-3">\r\n      <label class="c8y-checkbox checkbox-inline" title="isFilterPaneEnabled">\r\n        <input type="checkbox" value="Add Stack" [(ngModel)]="config.isFilterPaneEnabled"\r\n          >\r\n        <span></span>\r\n        <span>{{\'Filter Pane\'}}</span>\r\n      </label>\r\n    </div>\r\n    <div class="col-xs-1 col-md-1 col-lg-1"></div>\r\n    <div class="col-xs-3 col-md-3">\r\n      <label class="c8y-checkbox checkbox-inline" title="isNavPaneEnabled">\r\n        <input type="checkbox" value="Add Stack" [(ngModel)]="config.isNavPaneEnabled"\r\n          >\r\n        <span></span>\r\n        <span>{{\'Nav Pane\'}}</span>\r\n      </label>\r\n    </div>\r\n    \r\n  </div>\r\n  <div class="p-16 text-center separator-bottom">\r\n    <p class="lead m-0">{{\'Select the workspace you want to access.\' }}</p>\r\n    <p class="lead m-0">{{\'Select a report from the selected workspace.\' }}</p>\r\n  </div>\r\n  <form [formGroup]="form">\r\n    <c8y-form-group>\r\n      <label for="workspace">\r\n        {{\'Workspace\'}}\r\n      </label>\r\n      <div class="c8y-select-wrapper">\r\n        <select formControlName="workspace" name="workspace" id="workspace">\r\n          <option *ngFor="let workspace of workspaces" [ngValue]="workspace">\r\n            {{ workspace.name }}\r\n          </option>\r\n        </select>\r\n      </div>\r\n    </c8y-form-group>\r\n    <c8y-form-group>\r\n      <label for="report">\r\n        {{\'Report\' }}\r\n      </label>\r\n      <div *ngIf="visibleReports?.length === 0 || error || isLoading; else reportsSelect">\r\n        <c8y-loading *ngIf="isLoading"></c8y-loading>\r\n        <em *ngIf="!error && !isLoading; else errorMessage"> No reports available for chosen workspace</em>\r\n        <ng-template #errorMessage>\r\n          <div *ngIf="error && !isLoading">\r\n            <i [c8yIcon]="\'warning\'" class="m-r-4 text-danger"></i>\r\n            <em>{{ error }}</em>\r\n          </div>\r\n        </ng-template>\r\n      </div>\r\n      <ng-template #reportsSelect>\r\n        <div class="c8y-select-wrapper">\r\n          <select formControlName="report" name="report" id="report">\r\n            <option *ngFor="let report of visibleReports" [ngValue]="report">\r\n              {{ report.name }}\r\n            </option>\r\n          </select>\r\n        </div>\r\n      </ng-template>\r\n    </c8y-form-group>\r\n  </form>\r\n\r\n</div>',styles:[".configSection{display:grid;border:1px solid rgba(0,0,0,.3);border-radius:4px;margin:.25em;padding:.25em}.row{padding:.5em}"]}]}],v.ctorParameters=function(){return[{type:f},{type:i.FormBuilder},{type:r.AlertService},{type:u}]},v.propDecorators={config:[{type:t.Input}]};var b={id:"powerbi.widget",label:"Power BI Widget",description:"Power BI Widget",component:g,configComponent:v,data:{ng1:{options:{noDeviceTarget:!0,noNewWidgets:!1,deviceTargetNotRequired:!0,groupsSelectable:!0}}}},m=function(){};m.decorators=[{type:t.NgModule,args:[{declarations:[g,v],imports:[r.CoreModule,a.CollapseModule,s.RouterModule,r.FormsModule,i.ReactiveFormsModule],providers:[u,f,{provide:r.HOOK_COMPONENTS,multi:!0,useValue:b}],exports:[g,v],entryComponents:[g,v]}]}],e.GpPowerbiWidgetModule=m,e["ɵ0"]=b,e["ɵa"]=g,e["ɵb"]=f,e["ɵc"]=u,e["ɵd"]=v,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=custom-widget.umd.min.js.map